build:
  zinc:
    image: presslabs/zinc
    pull: true
    auth_config:
      username: presslabsbot
      password: $$DOCKER_PASSWORD
      email: ping@presslabs.com
    environment:
      - BROKER_URL=redis://redis:6379/0
      - CELERY_RESULT_BACKEND=redis://redis:6379/1
      - ONCE_REDIS_URL=redis://redis:6379/2
    commands:
      - pip install -U -r requirements/test.txt
      - python manage.py test -v2

compose:
  redis:
    image: redis

publish:
  docker:
    username: presslabsbot
    password: $$DOCKER_PASSWORD
    email: ping@presslabs.com
    repo: presslabs/zinc
    tag: $${BRANCH/master/latest}
    when:
      event: push