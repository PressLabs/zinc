build:
  zinc:
    image: presslabs/zinc
    pull: true
    auth_config:
      username: presslabsbot
      password: $$DOCKER_PASSWORD
      email: ping@presslabs.com
    environment:
      - DJANGO_SETTINGS_MODULE=zinc.test_settings
      - ZINC_AWS_KEY=$$ZINC_AWS_KEY
      - ZINC_AWS_SECRET=$$ZINC_AWS_SECRET
    commands:
      - sed -i "s/raven.fetch_git_sha(os.path.dirname(os.pardir))/'$$COMMIT'/g" zinc/settings.py
      - pip install -U -r requirements.dev.txt
      - pep8 --max-line-length=100 --exclude=migrations .
      - py.test --capture=no -v --tb=native

publish:
  docker:
    username: presslabsbot
    password: $$DOCKER_PASSWORD
    email: ping@presslabs.com
    repo: presslabs/zinc
    tag: $${BRANCH/master/latest}
    storage_path: /drone/docker
    when:
      event: push

cache:
  mount:
    - /drone/docker
